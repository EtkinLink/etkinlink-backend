name: CI (build & compose smoke test)

on:
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # (Opsiyonel) Python bağımlılık cache'i istersen ekleyebilirsin; burada gerek yok.

      - name: Compose up (build & start)
        run: |
          docker compose up -d --build
          echo "Waiting for API to be healthy..."
          # 30x dene, her seferinde 2s bekle
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || true)
            if [ "$code" = "200" ]; then
              echo "API is healthy ✅"
              break
            fi
            echo "health=$code (try $i/30)"; sleep 2
          done
          # son kontrol
          curl -f http://localhost:8000/health

      - name: Hit /users (should 200 even if empty/seed)
        run: |
          curl -sS http://localhost:8000/users | tee users.json
          # sadece 200 kontrolü (içerik doğrulaması yapmıyoruz)
          code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/users)
          if [ "$code" != "200" ]; then
            echo "Unexpected status: $code"; exit 1
          fi

      - name: Show compose logs on failure
        if: failure()
        run: |
          echo "===== API LOGS ====="
          docker compose logs api || true
          echo "===== DB LOGS ====="
          docker compose logs db || true

      - name: Compose down
        if: always()
        run: docker compose down
